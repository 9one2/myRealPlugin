<!DOCTYPE html>
<html>

<head>
  <style>
    @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css');

    body {
      font-family: 'Pretendard';
      margin: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      width: 100%;
      height: 100vh;
      overflow: hidden;
    }

    .content-wrapper {
      padding: 20px;
      height: calc(100% - 40px);
      overflow-y: auto;
      scrollbar-width: none;
    }

    input,
    textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      border: 1.5px solid #ddd;
      border-radius: 8px;
      font-family: "Pretendard";
    }

    #pluginList,
    #search-results {
      margin-top: 20px;
      flex-grow: 1;
      overflow-y: auto;
    }

    .plugin-item {
      border: 2px solid #f0f3f7;
      padding: 16px 8px 16px 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: flex-start;
      cursor: pointer;
      border-radius: 12px;
      flex-wrap: wrap;
    }

    .plugin-item:hover {
      background-color: #f0f3f7;
    }

    .plugin-item img {
      width: 40px;
      height: 40px;
      margin-right: 12px;
      display: flex;
      border-radius: 999px;
      margin-top: 4px;
      object-fit: cover;
      /* Ïù¥ÎØ∏ÏßÄÍ∞Ä Î°úÎìúÎêòÏßÄ ÏïäÏùÑ Í≤ΩÏö∞Î•º ÏúÑÌïú Í∏∞Î≥∏ Ïä§ÌÉÄÏùº */
      background-color: #e0e0e0;
    }

    .plugin-info {
      display: flex;
      flex-direction: column;
      flex-grow: 1;
      min-width: 200px;
      gap: 4px;
    }

    .plugin-actions {
      display: flex;
      flex-direction: column;
      gap: 8px;
      width: 40px;
    }

    .pluginUrl {
      padding: 12px;
    }

    .myTitle {
      background-color: #f8e8e2;
      padding: 16px 12px;
      border-radius: 8px;
      text-align: center;
      font-weight: 500;
      color: coral;
    }

    .btnAdd,
    .add-to-my-plugins {
      padding: 12px;
      border: none;
      background-color: coral;
      color: #fff;
      font-weight: 600;
      font-size: 14px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }

    .btnAdd:hover,
    .add-to-my-plugins:hover {
      background-color: #df521f;
      transition: ease-out 0.3s;
    }

    #tabs {
      display: flex;
      justify-content: space-around;
      margin-bottom: 20px;
    }

    .tab {
      padding: 10px;
      cursor: pointer;
      border-bottom: 2px solid #ddd;
      width: 33.33%;
      text-align: center;
    }

    .active-tab {
      font-weight: bold;
      border-bottom: 2px solid coral;
      color: coral;
    }

    .content {
      display: none;
    }

    .content.active {
      display: block;
    }

    .chip {
      display: inline-block;
      padding: 5px 10px;
      margin: 5px;
      background-color: #E5E5E5;
      border-radius: 16px;
      cursor: pointer;
    }

    .chip.active {
      background-color: coral;
      color: white;
    }

    .delete-button,
    .add-to-my-plugins {
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .delete-button:hover,
    .add-to-my-plugins:hover {
      background-color: #d0d3df;
      border-radius: 6px;
    }

    #resizer {
      position: absolute;
      right: 0;
      bottom: 0;
      width: 20px;
      height: 20px;
      cursor: se-resize;
      background: linear-gradient(135deg, transparent 50%, #ccc 50%);
    }

    #categoryChips {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
    }

    .category-chip {
      background-color: #E5E5E5;
      border-radius: 16px;
      padding: 5px 10px;
      cursor: pointer;
      font-size: 12px;
    }

    .category-chip.selected {
      background-color: coral;
      color: white;
    }

    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      display: none;
    }

    .autocomplete-wrapper {
      position: relative;
    }

    .autocomplete-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border: 1px solid #ddd;
      border-radius: 0 0 8px 8px;
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
    }

    .autocomplete-item {
      padding: 8px 12px;
      cursor: pointer;
    }

    .autocomplete-item:hover {
      background-color: #f0f3f7;
    }

    #search-input-wrapper {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    #search-input {
      flex-grow: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    #search-button {
      padding: 10px 20px;
      background-color: coral;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    #loading-spinner {
      display: none;
      justify-content: center;
      align-items: center;
      margin-top: 20px;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid coral;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0, 0, 0, 0.4);
    }

    .modal-content {
      background-color: #fefefe;
      margin: 15% auto;
      padding: 20px;
      border: 1px solid #888;
      width: 80%;
      border-radius: 8px;
    }

    .close {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }

    .close:hover,
    .close:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
  </style>
  <script src="https://unpkg.com/feather-icons"></script>
</head>

<body>
  <div class="content-wrapper">
    <div id="tabs">
      <div class="tab active-tab" data-tab="add-plugin">Add Plugin</div>
      <div class="tab" data-tab="plugin-list">My Plugin List</div>
      <div class="tab" data-tab="search-plugins">Search Plugins</div>
    </div>
    <div id="add-plugin" class="content active">
      <div class="inputs">
        <input class="inputUrl" id="pluginUrl" type="text" placeholder="Enter plugin URL from Figma Community" required>
        <div class="autocomplete-wrapper">
          <input class="inputCategory" id="pluginCategory" type="text" placeholder="Enter or select category" required>
          <div class="autocomplete-dropdown" id="categoryDropdown" style="display: none;"></div>
        </div>
        <input class="inputName" id="pluginName" type="text" placeholder="Enter plugin name (optional)">
        <textarea class="inputDesc" id="pluginDescription" placeholder="Enter plugin description (optional)" rows="3"></textarea>
        <button class="btnAdd" style="gap: 6px;" id="addPlugin">Save this plugin <span style="font-size: 20px; margin-top: 4px;">üòé</span></button>
      </div>
    </div>
    <div id="plugin-list" class="content">
      <div id="category-chips"></div>
      <div id="pluginList"></div>
    </div>
    <div id="search-plugins" class="content">
      <div id="search-input-wrapper">
        <input type="text" id="search-input" placeholder="Search plugins...">
        <button id="search-button">Search</button>
      </div>
      <div id="loading-spinner">
        <div class="spinner"></div>
      </div>
      <div id="search-results"></div>
    </div>
  </div>

  <div id="add-plugin-modal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>Add Plugin to My List</h2>
      <input id="modal-plugin-name" type="text" placeholder="Plugin Name">
      <input id="modal-plugin-url" type="text" placeholder="Plugin URL" readonly>
      <div class="autocomplete-wrapper">
        <input id="modal-plugin-category" type="text" placeholder="Enter or select category" required>
        <div id="modal-category-dropdown" class="autocomplete-dropdown" style="display: none;"></div>
      </div>
      <textarea id="modal-plugin-description" placeholder="Enter plugin description (optional)" rows="3"></textarea>
      <button id="modal-add-plugin">Add Plugin</button>
    </div>
  </div>

  <div id="resizer"></div>
  <div id="toast"></div>

  <script>
    (function () {
      let existingCategories = [];
      let myPlugins = [];
      let searchTimeout; // Îã®Ïùº ÏÑ†Ïñ∏

      // Î≥ÄÏàò ÏÑ†Ïñ∏
      const searchInput = document.getElementById('search-input');
      const searchButton = document.getElementById('search-button');
      const addPluginButton = document.getElementById('addPlugin');
      const modalAddPluginButton = document.getElementById('modal-add-plugin');
      const modalCloseButton = document.querySelector('.close');

      // Render Plugin List
      function renderPluginList(plugins) {
        console.log('Rendering plugin list:', plugins);
        const pluginList = document.getElementById('pluginList');
        pluginList.innerHTML = '';
        const categories = new Set();

        myPlugins = plugins;

        plugins.forEach(plugin => {
          console.log('Plugin Icon:', plugin.pluginIcon); // ÎîîÎ≤ÑÍπÖ Î°úÍ∑∏
          categories.add(plugin.category);
          const item = document.createElement('div');
          item.className = 'plugin-item';
          item.dataset.category = plugin.category;
          item.dataset.id = plugin.id;
          item.dataset.url = plugin.pluginUrl; // URLÏùÑ Îç∞Ïù¥ÌÑ∞ ÏÜçÏÑ±ÏúºÎ°ú Ï†ÄÏû•
          item.innerHTML = `
            <img src="${plugin.pluginIcon}" alt="${plugin.pluginName}">
            <div class="plugin-info">
              <div style="display:flex; flex-direction:column; gap: 4px;">
                <h4 style="margin:0;font-size: 18px; color: #3a3d51; font-weight: 300;">${plugin.pluginName}</h4>
                ${plugin.pluginDescription ? `<p style="margin:0; font-size:13px; color: #96a1aa;">${plugin.pluginDescription}</p>` : ''}
              </div>
              <small style="color: coral; background-color: #ff7f5021; width: fit-content; padding: 2px 4px; border-radius: 2px;">${plugin.category}</small>
            </div>
            <div class="plugin-actions">
              <button class="delete-button" onclick="deletePlugin(event, '${plugin.id}', '${plugin.category}')" title="Delete plugin">
                <i data-feather="trash-2" stroke="#96a1aa" stroke-width="1.5"></i>
              </button>
            </div>
          `;
          // ÌîåÎü¨Í∑∏Ïù∏ ÏïÑÏù¥ÌÖú ÌÅ¥Î¶≠ Ïãú URL Ïù¥Îèô
          item.onclick = (e) => {
            if (!e.target.closest('.delete-button')) {
              const pluginUrl = item.dataset.url;
              if (pluginUrl) {
                openPluginPage(plugin.id, pluginUrl);
              } else {
                console.error('No URL available for plugin:', plugin.id);
              }
            }
          };
          pluginList.appendChild(item);
        });

        updateExistingCategories(plugins);
        updateCategoryChips(Array.from(categories));
        updateCategoryDropdown();
        feather.replace();
      }

      // Open Plugin Page
      function openPluginPage(pluginId, pluginUrl) {
        if (pluginUrl) {
          console.log('Opening plugin page:', pluginId, pluginUrl);
          parent.postMessage({ pluginMessage: { type: 'open-plugin-page', url: pluginUrl } }, '*');
        } else {
          console.error('No URL provided for plugin:', pluginId);
        }
      }

      // Delete Plugin
      window.deletePlugin = function (event, pluginId, category) {
        event.stopPropagation();
        if (confirm('Are you sure you want to delete this plugin from the category?')) {
          console.log('Deleting plugin:', pluginId, 'from category:', category);
          parent.postMessage({ pluginMessage: { type: 'delete-plugin', pluginId, category } }, '*');
        }
      };

      // Update Existing Categories
      function updateExistingCategories(plugins) {
        existingCategories = Array.from(new Set(plugins.map(plugin => plugin.category)));
      }

      // Switch Tab
      function switchTab(tabName) {
        console.log('Switching to tab:', tabName);
        document.querySelectorAll('.tab').forEach(tab => {
          tab.classList.toggle('active-tab', tab.dataset.tab === tabName);
        });
        document.querySelectorAll('.content').forEach(content => {
          content.classList.toggle('active', content.id === tabName);
        });
        if (tabName === 'plugin-list') {
          console.log('Requesting plugins list');
          parent.postMessage({ pluginMessage: { type: 'get-plugins' } }, '*');
        } else if (tabName === 'add-plugin') {
          updateCategoryDropdown();
        }
      }

      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          console.log('Tab clicked:', tab.dataset.tab);
          switchTab(tab.dataset.tab);
        });
      });

      // Show Toast Notification
      function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.style.display = 'block';
        setTimeout(() => {
          toast.style.display = 'none';
        }, 3000);
      }

      // Update Category Dropdown
      function updateCategoryDropdown() {
        const dropdown = document.getElementById('categoryDropdown');
        dropdown.innerHTML = '';
        existingCategories.forEach(category => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = category;
          item.onclick = () => selectCategory(category);
          dropdown.appendChild(item);
        });
      }

      // Select Category
      function selectCategory(category) {
        document.getElementById('pluginCategory').value = category;
        document.getElementById('categoryDropdown').style.display = 'none';
      }

      // Plugin Category Input Events
      document.getElementById('pluginCategory').addEventListener('input', function () {
        const inputValue = this.value.trim().toLowerCase();
        const dropdown = document.getElementById('categoryDropdown');
        dropdown.innerHTML = '';

        const filteredCategories = existingCategories.filter(category =>
          category.toLowerCase().includes(inputValue)
        );

        if (inputValue && !existingCategories.some(cat => cat.toLowerCase() === inputValue)) {
          const newItem = document.createElement('div');
          newItem.className = 'autocomplete-item';
          newItem.textContent = `Add "${this.value.trim()}"`;
          newItem.onclick = () => selectCategory(this.value.trim());
          dropdown.appendChild(newItem);
        }

        filteredCategories.forEach(category => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = category;
          item.onclick = () => selectCategory(category);
          dropdown.appendChild(item);
        });

        dropdown.style.display = (filteredCategories.length || inputValue) ? 'block' : 'none';
      });

      document.getElementById('pluginCategory').addEventListener('focus', function () {
        updateCategoryDropdown();
        document.getElementById('categoryDropdown').style.display = 'block';
      });

      document.addEventListener('click', function (e) {
        if (!e.target.closest('.autocomplete-wrapper')) {
          document.getElementById('categoryDropdown').style.display = 'none';
        }
      });

      // Add Plugin Button Click Handler
      addPluginButton.onclick = () => {
        console.log('Add plugin button clicked');
        const url = document.getElementById('pluginUrl').value.trim();
        const name = document.getElementById('pluginName').value.trim();
        const category = document.getElementById('pluginCategory').value.trim();
        const description = document.getElementById('pluginDescription').value.trim();

        if (!url || !category) {
          showToast('URL and category are required');
          return;
        }

        parent.postMessage({ pluginMessage: { type: 'add-plugin', url, name, category, description } }, '*');

        // Clear input fields after adding
        document.getElementById('pluginUrl').value = '';
        document.getElementById('pluginName').value = '';
        document.getElementById('pluginCategory').value = '';
        document.getElementById('pluginDescription').value = '';
      };

      // Update Category Chips
      function updateCategoryChips(categories) {
        console.log('Updating category chips:', categories);
        const chipsContainer = document.getElementById('category-chips');
        chipsContainer.innerHTML = '<div class="chip active" data-category="all">All</div>';
        categories.forEach(category => {
          chipsContainer.innerHTML += `<div class="chip" data-category="${category}">${category}</div>`;
        });

        chipsContainer.addEventListener('click', (e) => {
          if (e.target.classList.contains('chip')) {
            console.log('Category chip clicked:', e.target.dataset.category);
            document.querySelectorAll('.chip').forEach(chip => chip.classList.remove('active'));
            e.target.classList.add('active');
            filterPlugins(e.target.dataset.category);
          }
        });
      }

      // Filter Plugins by Category
      function filterPlugins(category) {
        console.log('Filtering plugins by category:', category);
        const plugins = document.querySelectorAll('.plugin-item');
        plugins.forEach(plugin => {
          if (category === 'all' || plugin.dataset.category === category) {
            plugin.style.display = 'flex';
          } else {
            plugin.style.display = 'none';
          }
        });
      }

      // Resizer Functionality
      const resizer = document.getElementById('resizer');
      let isResizing = false;
      let startX, startY, startWidth, startHeight;

      resizer.addEventListener('mousedown', initResize, false);

      function initResize(e) {
        isResizing = true;
        startX = e.clientX;
        startY = e.clientY;
        startWidth = window.innerWidth;
        startHeight = window.innerHeight;

        document.addEventListener('mousemove', resize, false);
        document.addEventListener('mouseup', stopResize, false);
      }

      function resize(e) {
        if (!isResizing) return;

        const newWidth = Math.max(300, startWidth + (e.clientX - startX));
        const newHeight = Math.max(300, startHeight + (e.clientY - startY));

        parent.postMessage({ pluginMessage: { type: 'resize', width: newWidth, height: newHeight } }, '*');
      }

      function stopResize() {
        isResizing = false;
        document.removeEventListener('mousemove', resize, false);
        document.removeEventListener('mouseup', stopResize, false);
      }

      // Load Plugins on Initialization
      function loadPlugins() {
        console.log('Requesting initial plugins list');
        parent.postMessage({ pluginMessage: { type: 'get-plugins' } }, '*');
      }

      // Handle Incoming Messages from code.ts
      window.onmessage = (event) => {
        const message = event.data.pluginMessage;
        if (message) {
          console.log('Received message from plugin:', message);
          if (message.type === 'plugins-list') {
            renderPluginList(message.plugins);
          } else if (message.type === 'search-results') {
            hideLoadingSpinner();
            renderSearchResults(message.results);
          } else if (message.type === 'plugin-added') {
            showToast('Plugin added successfully');
            switchTab('plugin-list');
          } else if (message.type === 'plugin-visibility-toggled') {
            const pluginItem = document.querySelector(`.plugin-item[data-id="${message.pluginId}"]`);
            if (pluginItem) {
              const toggleButton = pluginItem.querySelector('.toggle-visibility-button');
              const icon = toggleButton.querySelector('i');
              if (message.hidden) {
                icon.setAttribute('data-feather', 'eye');
                toggleButton.title = 'Show plugin';
              } else {
                icon.setAttribute('data-feather', 'eye-off');
                toggleButton.title = 'Hide plugin';
              }
              feather.replace();
            }
          }
        }
      };

      // Search Functionality
      function performSearch() {
        const query = searchInput.value.trim();
        if (query.length >= 2) {
          showLoadingSpinner();
          parent.postMessage({ pluginMessage: { type: 'search-plugins', query } }, '*');
        } else {
          document.getElementById('search-results').innerHTML = '';
          hideLoadingSpinner();
        }
      }

      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
      });

      searchButton.addEventListener('click', performSearch);

      function showLoadingSpinner() {
        document.getElementById('loading-spinner').style.display = 'flex';
        document.getElementById('search-results').innerHTML = '';
      }

      function hideLoadingSpinner() {
        document.getElementById('loading-spinner').style.display = 'none';
      }

      function renderSearchResults(results) {
        console.log('Displaying search results:', results);
        const searchResultsContainer = document.getElementById('search-results');
        searchResultsContainer.innerHTML = '';

        if (results.length === 0) {
          searchResultsContainer.innerHTML = '<p>No results found.</p>';
          return;
        }

        results.forEach(plugin => {
          console.log('Processing plugin:', plugin);
          const pluginElement = document.createElement('div');
          pluginElement.className = 'plugin-item';

          pluginElement.innerHTML = `
            <div class="listWrap" style="display: flex; align-items: flex-start; flex-wrap: wrap; gap:8px; width:100%;">
              <img src="${plugin.pluginIcon}" alt="${plugin.pluginName}" class="plugin-icon">
              <div class="plugin-info" style="display: flex; flex-direction: column; flex-grow: 1; min-width: 200px; gap: 8px;">
                <h3 style="margin:0;font-size: 18px; color: #3a3d51; font-weight: 300; width: 280px; white-space: nowrap; overflow: hidden; text-overflow:ellipsis;">${plugin.pluginName}</h3>
                <p style="margin:0; font-size:13px; color: #96a1aa; width: 280px; white-space: nowrap; overflow: hidden; text-overflow:ellipsis;">${plugin.pluginDescription || 'No description available'}</p>
              </div>
              <button class="add-to-my-plugins" data-plugin-id="${plugin.id}" title="Add to My Plugins">
                <i data-feather="plus-circle" stroke="#96a1aa" stroke-width="1.5"></i>
              </button>
            </div>
          `;
          searchResultsContainer.appendChild(pluginElement);
        });

        document.querySelectorAll('.add-to-my-plugins').forEach(button => {
          button.addEventListener('click', (e) => {
            e.stopPropagation();
            const buttonElement = e.currentTarget;
            const pluginId = buttonElement.dataset.pluginId;
            const plugin = myPlugins.find(p => p.id === pluginId) || null;
            if (plugin) {
              showAddPluginModal(plugin);
            } else {
              console.error('Plugin not found:', pluginId);
            }
          });
        });

        feather.replace();
      }

      // Show Add Plugin Modal
      function showAddPluginModal(plugin) {
        const modal = document.getElementById('add-plugin-modal');
        document.getElementById('modal-plugin-name').value = plugin.pluginName;
        document.getElementById('modal-plugin-url').value = plugin.pluginUrl;
        document.getElementById('modal-plugin-description').value = plugin.pluginDescription || '';
        document.getElementById('modal-plugin-category').value = '';
        modal.style.display = 'block';
      }

      // Modal Close Handler
      modalCloseButton.onclick = function () {
        document.getElementById('add-plugin-modal').style.display = 'none';
      }

      window.onclick = function (event) {
        const modal = document.getElementById('add-plugin-modal');
        if (event.target == modal) {
          modal.style.display = 'none';
        }
      }

      // Modal Add Plugin Button Click Handler
      modalAddPluginButton.onclick = function () {
        const name = document.getElementById('modal-plugin-name').value.trim();
        const category = document.getElementById('modal-plugin-category').value.trim();
        const description = document.getElementById('modal-plugin-description').value.trim();

        if (!name || !category) {
          showToast('Name and category are required');
          return;
        }

        const pluginInfo = {
          name: name,
          url: document.getElementById('modal-plugin-url').value,
          description: description,
          category: category
        };

        parent.postMessage({ pluginMessage: { type: 'add-plugin', ...pluginInfo } }, '*');
        document.getElementById('add-plugin-modal').style.display = 'none';
      };

      // Update Category Dropdown for Modal
      function updateModalCategoryDropdown() {
        const dropdown = document.getElementById('modal-category-dropdown');
        dropdown.innerHTML = '';
        existingCategories.forEach(category => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = category;
          item.onclick = () => selectModalCategory(category);
          dropdown.appendChild(item);
        });
      }

      // Select Modal Category
      function selectModalCategory(category) {
        document.getElementById('modal-plugin-category').value = category;
        document.getElementById('modal-category-dropdown').style.display = 'none';
      }

      // Plugin Category Input Events for Modal
      document.getElementById('modal-plugin-category').addEventListener('input', function () {
        const inputValue = this.value.trim().toLowerCase();
        const dropdown = document.getElementById('modal-category-dropdown');
        dropdown.innerHTML = '';

        const filteredCategories = existingCategories.filter(category =>
          category.toLowerCase().includes(inputValue)
        );

        if (inputValue && !existingCategories.some(cat => cat.toLowerCase() === inputValue)) {
          const newItem = document.createElement('div');
          newItem.className = 'autocomplete-item';
          newItem.textContent = `Add "${this.value.trim()}"`;
          newItem.onclick = () => selectModalCategory(this.value.trim());
          dropdown.appendChild(newItem);
        }

        filteredCategories.forEach(category => {
          const item = document.createElement('div');
          item.className = 'autocomplete-item';
          item.textContent = category;
          item.onclick = () => selectModalCategory(category);
          dropdown.appendChild(item);
        });

        dropdown.style.display = (filteredCategories.length || inputValue) ? 'block' : 'none';
      });

      document.getElementById('modal-plugin-category').addEventListener('focus', function () {
        updateModalCategoryDropdown();
        document.getElementById('modal-category-dropdown').style.display = 'block';
      });

      document.addEventListener('click', function (e) {
        if (!e.target.closest('#modal-plugin-category')) {
          document.getElementById('modal-category-dropdown').style.display = 'none';
        }
      });

      // Initialize Feather Icons
      function initFeatherIcons() {
        feather.replace();

        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.type === 'childList') {
              feather.replace();
            }
          });
        });

        observer.observe(document.body, {
          childList: true,
          subtree: true
        });
      }

      document.addEventListener('DOMContentLoaded', initFeatherIcons);

      // Handle Incoming Messages from code.ts
      window.onmessage = (event) => {
        const message = event.data.pluginMessage;
        if (message) {
          console.log('Received message from plugin:', message);
          if (message.type === 'plugins-list') {
            renderPluginList(message.plugins);
          } else if (message.type === 'search-results') {
            hideLoadingSpinner();
            renderSearchResults(message.results);
          } else if (message.type === 'plugin-added') {
            showToast('Plugin added successfully');
            switchTab('plugin-list');
          } else if (message.type === 'plugin-visibility-toggled') {
            const pluginItem = document.querySelector(`.plugin-item[data-id="${message.pluginId}"]`);
            if (pluginItem) {
              const toggleButton = pluginItem.querySelector('.toggle-visibility-button');
              const icon = toggleButton.querySelector('i');
              if (message.hidden) {
                icon.setAttribute('data-feather', 'eye');
                toggleButton.title = 'Show plugin';
              } else {
                icon.setAttribute('data-feather', 'eye-off');
                toggleButton.title = 'Hide plugin';
              }
              feather.replace();
            }
          }
        }
      };

      // Search Functionality
      function performSearch() {
        const query = searchInput.value.trim();
        if (query.length >= 2) {
          showLoadingSpinner();
          parent.postMessage({ pluginMessage: { type: 'search-plugins', query } }, '*');
        } else {
          document.getElementById('search-results').innerHTML = '';
          hideLoadingSpinner();
        }
      }

      searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(performSearch, 300);
      });

      searchButton.addEventListener('click', performSearch);

      function showLoadingSpinner() {
        document.getElementById('loading-spinner').style.display = 'flex';
        document.getElementById('search-results').innerHTML = '';
      }

      function hideLoadingSpinner() {
        document.getElementById('loading-spinner').style.display = 'none';
      }

      function renderSearchResults(results) {
        console.log('Displaying search results:', results);
        const searchResultsContainer = document.getElementById('search-results');
        searchResultsContainer.innerHTML = '';

        if (results.length === 0) {
          searchResultsContainer.innerHTML = '<p>No results found.</p>';
          return;
        }

        results.forEach(plugin => {
          console.log('Processing plugin:', plugin);
          const pluginElement = document.createElement('div');
          pluginElement.className = 'plugin-item';

          pluginElement.innerHTML = `
            <div class="listWrap" style="display: flex; align-items: flex-start; flex-wrap: wrap; gap:8px; width:100%;">
              <img src="${plugin.pluginIcon}" alt="${plugin.pluginName}" class="plugin-icon">
              <div class="plugin-info" style="display: flex; flex-direction: column; flex-grow: 1; min-width: 200px; gap: 8px;">
                <h3 style="margin:0;font-size: 18px; color: #3a3d51; font-weight: 300; width: 280px; white-space: nowrap; overflow: hidden; text-overflow:ellipsis;">${plugin.pluginName}</h3>
                <p style="margin:0; font-size:13px; color: #96a1aa; width: 280px; white-space: nowrap; overflow: hidden; text-overflow:ellipsis;">${plugin.pluginDescription || 'No description available'}</p>
              </div>
              <button class="add-to-my-plugins" data-plugin-id="${plugin.id}" title="Add to My Plugins">
                <i data-feather="plus-circle" stroke="#96a1aa" stroke-width="1.5"></i>
              </button>
            </div>
          `;
          searchResultsContainer.appendChild(pluginElement);
        });

        document.querySelectorAll('.add-to-my-plugins').forEach(button => {
          button.addEventListener('click', (e) => {
            e.stopPropagation();
            const buttonElement = e.currentTarget;
            const pluginId = buttonElement.dataset.pluginId;
            const plugin = myPlugins.find(p => p.id === pluginId) || null;
            if (plugin) {
              showAddPluginModal(plugin);
            } else {
              console.error('Plugin not found:', pluginId);
            }
          });
        });

        feather.replace();
      }

      // Initialize Plugins on Load
      loadPlugins();
    })();
  </script>
</body>

</html>
