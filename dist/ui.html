<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <title>Plugin Manager</title>
    <style>
      /* 기본 스타일 */
      body {
        font-family: "Pretendard", sans-serif;
        margin: 0;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        width: 100%;
        height: 100vh;
        overflow: hidden;
      }

      .content-wrapper {
        padding: 20px;
        height: fit-content;
        overflow-y: auto;
        scrollbar-width: none;
      }

      input,
      textarea {
        width: 100%;
        padding: 12px;
        background-color: #f8f8f8;
        border-radius: 8px;
        font-family: "Pretendard";
        font-size: 16px;
      }

      #pluginList,
      #search-results,
      #default-plugin-list {
        margin-top: 20px;
        flex-grow: 1;
        overflow-y: auto;
      }

      .plugin-item {
        border-bottom: 2px solid #f8f8f8;
        padding: 16px 4px;
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .plugin-item:hover {
        background-color: #f0f3f7;
      }

      .plugin-item img {
        width: 60px;
        height: 60px;
        margin-right: 16px;
        display: flex;
        border-radius: 8px;
        margin-top: 4px;
        object-fit: cover;
        box-shadow: 0px 2px 5px 2px rgba(0, 0, 0, 0.04);
      }

      .plugin-info {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        min-width: 200px;
        gap: 16px;
      }

      .plugin-actions {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .btnAdd,
      .add-to-my-plugins,
      .floating-add-button {
        padding: 12px;
        border: none;
        background-color: #090909;
        color: #fff;
        font-weight: 400;
        font-size: 14px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
      }

      .btnAdd:hover,
      .add-to-my-plugins:hover,
      .floating-add-button:hover {
        background-color: #df521f;
        transition: ease-out 0.3s;
      }

      #tabs {
        display: flex;
        justify-content: space-around;
        margin-bottom: 20px;
      }

      .tab {
        padding: 10px;
        cursor: pointer;
        border-bottom: 2px solid #ddd;
        width: 50%;
        text-align: center;
      }

      .active-tab {
        font-weight: bold;
        border-bottom: 2px solid #090909;
        color: #090909;
      }

      .content {
        display: none;
      }

      .content.active {
        display: block;
      }

      .chip {
        display: inline-block;
        padding: 6px 10px;
        background-color: #fff;
        border: 1px solid #e1e1e1;
        border-radius: 16px;
        cursor: pointer;
        color: #090909;
        font-size: 16px;
      }
      .chip:hover {
        background-color: #e1e1e1;
      }

      .chip.active {
        background-color: #090909;
        color: white;
      }

      .delete-button,
      .add-to-my-plugins {
        background: none;
        border: none;
        cursor: pointer;
        padding: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #96a1aa;
      }

      .delete-button:hover,
      .add-to-my-plugins:hover {
        background-color: #d0d3df;
        border-radius: 6px;
      }

      #category-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .category-chip {
        background-color: #e5e5e5;
        border-radius: 16px;
        padding: 6px 10px;
        cursor: pointer;
        font-size: 12px;
      }

      .category-chip.selected {
        background-color: #090909;
        color: white;
      }

      #toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 10px 20px;
        border-radius: 5px;
        display: none;
      }

      .autocomplete-wrapper {
        position: relative;
      }

      .autocomplete-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
      }

      .autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
      }

      .autocomplete-item:hover {
        background-color: #f0f3f7;
      }

      #search-input-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 20px;
      }

      #search-input {
        flex-grow: 1;
        padding: 16px;
        border-radius: 8px;
        border: none;
      }

      #search-reset-button {
        padding: 13px;
        background-color: #f8f8f8;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        align-self: center;
      }

      #loading-spinner {
        display: none;
        justify-content: center;
        align-items: center;
        margin-top: 20px;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #090909;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fefefe;
        margin: 15% auto;
        padding: 20px;
        border: 1.5px solid #888;
        width: 80%;
        max-width: 400px;
        border-radius: 8px;
      }

      .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }

      .close:hover,
      .close:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }

      .floating-add-button {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 60px;
        height: 60px;
        border-radius: 50%;
        font-size: 24px;
        justify-content: center;
        align-items: center;
        display: flex;
        z-index: 100;
      }
    </style>
    <script src="https://unpkg.com/feather-icons"></script>
  </head>

  <body>
    <div class="content-wrapper">
      <div id="tabs">
        <div class="tab active-tab" data-tab="home">Add Plugin</div>
        <div class="tab" data-tab="plugin-list">My Plugin List</div>
      </div>
      <div id="home" class="content active">
        <div id="search-input-wrapper">
          <input
            type="text"
            id="search-input"
            placeholder="Search plugin name.."
          />
          <button id="search-reset-button" style="display: none">
            <i data-feather="x" stroke="#96a1aa" stroke-width="2"></i>
          </button>
        </div>
        <!-- 로딩 상태 표시 -->
        <div id="search-loading" style="display: none; text-align: center; align-items: center; gap: 8px; justify-content: center;">
          <div class="spinner"></div>
          <p>검색 기능을 준비하고 있습니다</p>
        </div>
        <div id="category-chips"></div>
        <div id="loading-spinner">
          <div class="spinner"></div>
        </div>
        <div id="default-plugin-list"></div>
        <!-- 검색 결과가 없을 때 표시될 영역 -->
        <div id="no-results" style="display: none; text-align: center; margin: 40px 0 40px 0;">
          <img
            src="data:image/png;base64,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"
            alt="No results"
            style="width: 80px; height: 80px"
          />
          <p>No Results</p>
        </div>
        <div style="margin-top: 20px; text-align: center">
          <button
            id="survey-button"
            type="button"
            style="
              width: 100%;
              padding: 12px 20px;
              background-color: #363636;
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              display: flex;
              justify-content: center;
              align-items: center;
              gap: 4px;
              font-size: 16px;
            "
          >
            Send Opinion
            <i data-feather="arrow-right" stroke="#fff" stroke-width="1.5"></i>
          </button>
        </div>
      </div>
      <div id="plugin-list" class="content">
        <div
          id="category-chips-my-plugins"
          style="display: flex; flex-wrap: wrap; gap: 6px"
        ></div>
        <div id="pluginList"></div>
      </div>
    </div>

    <button class="floating-add-button" id="floating-add-button">
      <i data-feather="plus" stroke="#fff" stroke-width="2"></i>
    </button>

    <div id="add-plugin-modal" class="modal">
      <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Add Plugin</h2>
        <input id="modal-plugin-url" type="text" placeholder="Plugin URL" />
        <div class="autocomplete-wrapper">
          <input
            id="modal-plugin-category"
            type="text"
            placeholder="Enter or select category"
            required
          />
          <div
            id="modal-category-dropdown"
            class="autocomplete-dropdown"
            style="display: none"
          ></div>
        </div>
        <input
          id="modal-plugin-name"
          type="text"
          placeholder="Plugin Name (optional)"
        />
        <textarea
          id="modal-plugin-description"
          placeholder="Enter plugin description (optional)"
          rows="3"
        ></textarea>
        <button id="modal-add-plugin">Add Plugin</button>
      </div>
    </div>

    <div id="toast"></div>

    <script>
      (function () {
        let existingCategories = [];
        let existingCategoriesMyPlugins = [];
        let myPlugins = [];
        let defaultPlugins = [];
        let searchTimeout;
        let selectedPlugin = null;
        let currentDisplayedPlugins = [];
        let searchReady = false; // 검색 가능 여부 상태 변수

        // 변수 선언
        const searchInput = document.getElementById("search-input");
        const searchResetButton = document.getElementById(
          "search-reset-button"
        );
        const modalAddPluginButton =
          document.getElementById("modal-add-plugin");
        const modalCloseButton = document.querySelector(".close");
        const floatingAddButton = document.getElementById(
          "floating-add-button"
        );

        // 탭 전환
        function switchTab(tabName) {
          console.log("Switching to tab:", tabName);
          document.querySelectorAll(".tab").forEach((tab) => {
            tab.classList.toggle("active-tab", tab.dataset.tab === tabName);
          });
          document.querySelectorAll(".content").forEach((content) => {
            content.classList.toggle("active", content.id === tabName);
          });
          if (tabName === "plugin-list") {
            console.log("Requesting plugins list");
            parent.postMessage({ pluginMessage: { type: "get-plugins" } }, "*");
          } else if (tabName === "home") {
            currentDisplayedPlugins = defaultPlugins;
            renderDefaultPluginList(defaultPlugins);
            updateCategoryChips(defaultPlugins, "home");
          }
        }

        document.querySelectorAll(".tab").forEach((tab) => {
          tab.addEventListener("click", () => {
            console.log("Tab clicked:", tab.dataset.tab);
            switchTab(tab.dataset.tab);
          });
        });

        // 토스트 메시지 표시
        function showToast(message) {
          const toast = document.getElementById("toast");
          toast.textContent = message;
          toast.className = "show";
          setTimeout(() => {
            toast.className = toast.className.replace("show", "");
          }, 3000);
        }

        // 설문 이동
        document
          .getElementById("survey-button")
          .addEventListener("click", function () {
            window.open(
              "https://airtable.com/appoQJ18zMmkhzu10/pagLy5t6fiYpsOKf1/form",
              "_blank",
              "noopener,noreferrer"
            );
          });

        // 카테고리 칩 업데이트
        function updateCategoryChips(plugins, context) {
          let categories = new Set();
          plugins.forEach((plugin) => {
            if (plugin.categories && plugin.categories.length > 0) {
              plugin.categories.forEach((category) => categories.add(category));
            }
          });
          const chipsContainer =
            context === "home"
              ? document.getElementById("category-chips")
              : document.getElementById("category-chips-my-plugins");
          chipsContainer.innerHTML =
            '<div class="chip active" data-category="all">All</div>';
          categories.forEach((category) => {
            chipsContainer.innerHTML += `<div class="chip" data-category="${category}">${category}</div>`;
          });

          chipsContainer.querySelectorAll(".chip").forEach((chip) => {
            chip.addEventListener("click", (e) => {
              console.log("Category chip clicked:", e.target.dataset.category);
              chipsContainer
                .querySelectorAll(".chip")
                .forEach((chip) => chip.classList.remove("active"));
              e.target.classList.add("active");
              if (context === "home") {
                filterPlugins(
                  currentDisplayedPlugins,
                  e.target.dataset.category,
                  "default-plugin-list",
                  "home"
                );
              } else {
                filterPlugins(
                  myPlugins,
                  e.target.dataset.category,
                  "pluginList",
                  "my-plugins"
                );
              }
            });
          });
        }

        // 플러그인 필터링
        function filterPlugins(plugins, category, containerId, context) {
          console.log("Filtering plugins by category:", category);
          const container = document.getElementById(containerId);
          container.innerHTML = "";
          const filteredPlugins =
            category === "all"
              ? plugins
              : plugins.filter(
                  (plugin) =>
                    plugin.categories && plugin.categories.includes(category)
                );
          console.log(`Filtered plugins count: ${filteredPlugins.length}`);
          renderPluginItems(filteredPlugins, containerId, context);
        }

        // 기본 플러그인 목록 렌더링
        function renderDefaultPluginList(plugins) {
          currentDisplayedPlugins = plugins;
          const container = document.getElementById("default-plugin-list");
          container.innerHTML = "";
          renderPluginItems(plugins, "default-plugin-list", "home");
        }

        // 플러그인 아이템 렌더링 공통 함수
        function renderPluginItems(plugins, containerId, context) {
          const container = document.getElementById(containerId);
          container.innerHTML = ""; // 컨테이너 초기화
          console.log(
            `Rendering ${plugins.length} plugins into ${containerId} with context ${context}`
          );

          if (plugins.length === 0 && context === "home") {
            // 검색 결과가 없을 때
            document.getElementById("no-results").style.display = "block";
            return;
          } else {
            document.getElementById("no-results").style.display = "none";
          }

          plugins.forEach((plugin) => {
            const item = document.createElement("div");
            item.className = "plugin-item";
            item.dataset.id = plugin.id;
            item.dataset.url = plugin.pluginUrl;
            item.dataset.category = plugin.categories
              ? plugin.categories[0]
              : ""; // 첫 번째 카테고리 사용

            // My Plugin List에 해당 플러그인이 있는지 확인
            const isAdded = myPlugins.some(
              (myPlugin) => myPlugin.id === plugin.id
            );
            console.log(`Plugin: ${plugin.pluginName}, isAdded: ${isAdded}`);

            // Object.assign을 사용하여 플러그인 객체 복제 및 추가 데이터 삽입
            const pluginData = Object.assign({}, plugin, {
              category: plugin.categories.join(", "),
            });

            item.innerHTML = `
          <div class="infoWrap" style="display:flex; align-items:center; width:100%;">
              <img src="${plugin.pluginIcon}" alt="${plugin.pluginName}">
              <div class="plugin-info" >
                <div style="display:flex; flex-direction:column; gap: 6px;">
                  <h4 style="margin:0;font-size: 16px; color: #090909; font-weight: 300;">${
                    plugin.pluginName
                  }</h4>
                  ${
                    plugin.pluginDescription
                      ? `<p style="margin:0; font-size:12px; color: #A0A0A0; white-space: nowrap; width: 280px; overflow: hidden; text-overflow: ellipsis;">${plugin.pluginDescription}</p>`
                      : ""
                  }
                </div>
                ${
                  plugin.categories && plugin.categories.length > 0
                    ? `<small style=" display:none; color: #090909; background-color: #ff7f5021; width: fit-content; padding: 2px 4px; border-radius: 2px;">${plugin.categories.join(
                        ", "
                      )}</small>`
                    : ""
                }
                </div>
              </div>
              <div class="plugin-actions">
                ${
                  context === "my-plugins"
                    ? `
                      <button  class="delete-button" title="Delete plugin">
                        <i data-feather="trash-2" stroke="#96a1aa" stroke-width="1.5"></i>
                      </button>
                      `
                    : `
                      <button class="add-to-my-plugins ${
                        isAdded ? "added" : ""
                      }" title="${
                        isAdded ? "Added" : "Add to My Plugins"
                      }" style="white-space: nowrap;">
                        ${
                          isAdded
                            ? '<i data-feather="check" stroke="#96a1aa" stroke-width="2" width="24" height="24"></i>'
                            : `<i data-feather="plus" stroke="#96a1aa" stroke-width="1.5" width="20" height="20"></i> Add to list`
                        }
                      </button>
                      `
                }
              </div>
          `;

            // 스타일링 및 이벤트 처리
            if (context !== "my-plugins") {
              const addButton = item.querySelector(".add-to-my-plugins");
              if (isAdded) {
                addButton.classList.add("added-button");
                addButton.disabled = true;
              } else {
                addButton.classList.remove("added-button");
                addButton.disabled = false;
              }

              // 'Add to My Plugins' 버튼 클릭 핸들러
              addButton.addEventListener("click", (e) => {
                e.stopPropagation();
                console.log(
                  `Add button clicked for plugin: ${plugin.pluginName}`
                );
                // 선택된 플러그인을 저장
                selectedPlugin = plugin;
                // 모달 표시
                showAddPluginModalWithPlugin(plugin);
              });
            } else {
              // Delete 버튼 클릭 핸들러
              const deleteButton = item.querySelector(".delete-button");
              if (deleteButton) {
                deleteButton.addEventListener("click", (e) => {
                  e.stopPropagation();
                  const pluginId = item.dataset.id;
                  const category = item.dataset.category;
                  console.log(
                    `Delete button clicked for plugin ID: ${pluginId}, category: ${category}`
                  );
                  if (
                    confirm(
                      "Are you sure you want to delete this plugin from the category?"
                    )
                  ) {
                    console.log(
                      "Deleting plugin:",
                      pluginId,
                      "from category:",
                      category
                    );
                    parent.postMessage(
                      {
                        pluginMessage: {
                          type: "delete-plugin",
                          pluginId,
                          category,
                        },
                      },
                      "*"
                    );
                  }
                });
              }
            }

            // 플러그인 아이템 클릭 시 URL 이동
            item.onclick = (e) => {
              if (
                context === "my-plugins" &&
                e.target.closest(".delete-button")
              ) {
                return; // 삭제 버튼 클릭 시에는 URL 이동하지 않음
              }
              if (
                !e.target.closest(".add-to-my-plugins") &&
                !e.target.closest(".delete-button")
              ) {
                const pluginUrl = item.dataset.url;
                if (pluginUrl) {
                  openPluginPage(plugin.id, pluginUrl);
                } else {
                  console.error("No URL available for plugin:", plugin.id);
                }
              }
            };

            container.appendChild(item);
          });
          feather.replace();
        }

        // Open Plugin Page
        function openPluginPage(pluginId, pluginUrl) {
          if (pluginUrl) {
            console.log("Opening plugin page:", pluginId, pluginUrl);
            parent.postMessage(
              { pluginMessage: { type: "open-plugin-page", url: pluginUrl } },
              "*"
            );
          } else {
            console.error("No URL provided for plugin:", pluginId);
          }
        }

        // My Plugin List 렌더링
        function renderPluginList(plugins) {
          console.log("Rendering plugin list:", plugins);
          const pluginList = document.getElementById("pluginList");
          pluginList.innerHTML = "";
          myPlugins = plugins; // myPlugins 업데이트
          renderPluginItems(plugins, "pluginList", "my-plugins");
          updateExistingCategories(plugins);
          updateCategoryChips(plugins, "my-plugins");

          // Home 탭의 버튼 상태 업데이트
          if (currentDisplayedPlugins && currentDisplayedPlugins.length > 0) {
            renderDefaultPluginList(currentDisplayedPlugins);
          }
        }

        // Existing Categories 업데이트
        function updateExistingCategories(plugins) {
          existingCategoriesMyPlugins = Array.from(
            new Set(plugins.flatMap((plugin) => plugin.categories))
          );
          console.log(
            "Updated existingCategoriesMyPlugins:",
            existingCategoriesMyPlugins
          );
        }

        // 검색 기능
        function performSearch() {
          const query = searchInput.value.trim();
          console.log("Performing search with query:", query);
          if (query.length >= 1) {
            if (!searchReady) {
              console.warn("Search is not ready yet");
              return;
            }
            showLoadingSpinner();
            // Hide category chips when performing search
            document.getElementById("category-chips").style.display = "none";
            parent.postMessage(
              { pluginMessage: { type: "search-plugins", query } },
              "*"
            );
          } else {
            hideLoadingSpinner();
            document.getElementById("category-chips").style.display = "block";
            currentDisplayedPlugins = defaultPlugins;
            renderDefaultPluginList(defaultPlugins);
            updateCategoryChips(defaultPlugins, "home");
            // Hide no-results message
            document.getElementById("no-results").style.display = "none";
          }
        }

        searchInput.addEventListener("input", () => {
          if (!searchReady) {
            console.warn("Search is not ready yet");
            return;
          }
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(performSearch, 300);
          searchResetButton.style.display =
            searchInput.value.trim().length > 0 ? "block" : "none";
        });

        searchResetButton.addEventListener("click", () => {
          console.log("Search reset button clicked");
          searchInput.value = "";
          searchResetButton.style.display = "none";
          document.getElementById("category-chips").style.display = "block";
          currentDisplayedPlugins = defaultPlugins;
          renderDefaultPluginList(defaultPlugins);
          updateCategoryChips(defaultPlugins, "home");
          // Hide no-results message
          document.getElementById("no-results").style.display = "none";
        });

        function showLoadingSpinner() {
          console.log("Showing loading spinner");
          document.getElementById("loading-spinner").style.display = "flex";
          document.getElementById("default-plugin-list").innerHTML = "";
          document.getElementById("no-results").style.display = "none";
        }

        function hideLoadingSpinner() {
          console.log("Hiding loading spinner");
          document.getElementById("loading-spinner").style.display = "none";
        }

        function renderSearchResults(results) {
          console.log("Displaying search results:", results);
          hideLoadingSpinner();
          currentDisplayedPlugins = results;
          if (results.length === 0) {
            // Show no-results message
            document.getElementById("no-results").style.display = "block";
          } else {
            document.getElementById("no-results").style.display = "none";
          }
          renderDefaultPluginList(results);
          // Since we're displaying search results, hide category chips
          document.getElementById("category-chips").style.display = "none";
        }

        // Floating Add Button 클릭 핸들러
        floatingAddButton.onclick = () => {
          console.log("Floating Add Button clicked");
          showAddPluginModal();
        };

        // Add Plugin Modal 표시
        function showAddPluginModal() {
          selectedPlugin = null; // 선택된 플러그인을 초기화
          const modal = document.getElementById("add-plugin-modal");
          document.getElementById("modal-plugin-name").value = "";
          document.getElementById("modal-plugin-url").value = "";
          document.getElementById("modal-plugin-description").value = "";
          document.getElementById("modal-plugin-category").value = "";
          modal.style.display = "block";
          console.log("Add Plugin Modal displayed");
        }

        // Modal 닫기 핸들러
        modalCloseButton.onclick = function () {
          console.log("Modal close button clicked");
          document.getElementById("add-plugin-modal").style.display = "none";
        };

        window.onclick = function (event) {
          const modal = document.getElementById("add-plugin-modal");
          if (event.target == modal) {
            console.log("Clicked outside modal, closing modal");
            modal.style.display = "none";
          }
        };

        // Modal Add Plugin 버튼 클릭 핸들러
        modalAddPluginButton.onclick = function () {
          const name = document
            .getElementById("modal-plugin-name")
            .value.trim();
          const category = document
            .getElementById("modal-plugin-category")
            .value.trim();
          const description = document
            .getElementById("modal-plugin-description")
            .value.trim();
          const url = document.getElementById("modal-plugin-url").value.trim();

          console.log("Modal Add Plugin button clicked with:", {
            name,
            category,
            description,
            url,
          });

          if (!url || !category) {
            showToast("URL and category are required");
            console.warn("URL or category is missing");
            return;
          }

          const pluginInfo = {
            type: "add-plugin",
            url: url,
            name: name,
            category: category,
            description: description,
          };

          console.log("Sending add-plugin message:", pluginInfo);
          parent.postMessage({ pluginMessage: pluginInfo }, "*");
          document.getElementById("add-plugin-modal").style.display = "none";
          console.log("Add Plugin Modal closed");
        };

        // Modal용 Category Dropdown 업데이트
        function updateModalCategoryDropdown() {
          const dropdown = document.getElementById("modal-category-dropdown");
          dropdown.innerHTML = "";
          const allCategories = Array.from(
            new Set([...existingCategories, ...existingCategoriesMyPlugins])
          );
          console.log("Updating Modal Category Dropdown with:", allCategories);
          allCategories.forEach((category) => {
            const item = document.createElement("div");
            item.className = "autocomplete-item";
            item.textContent = category;
            item.onclick = () => selectModalCategory(category);
            dropdown.appendChild(item);
          });
        }

        // Modal Category 선택
        function selectModalCategory(category) {
          console.log("Category selected from modal dropdown:", category);
          document.getElementById("modal-plugin-category").value = category;
          document.getElementById("modal-category-dropdown").style.display =
            "none";
        }

        // Modal Plugin Category 입력 이벤트
        document
          .getElementById("modal-plugin-category")
          .addEventListener("input", function () {
            const inputValue = this.value.trim().toLowerCase();
            const dropdown = document.getElementById("modal-category-dropdown");
            dropdown.innerHTML = "";
            const allCategories = Array.from(
              new Set([...existingCategories, ...existingCategoriesMyPlugins])
            );
            console.log("Modal category input changed:", inputValue);

            const filteredCategories = allCategories.filter((category) =>
              category.toLowerCase().includes(inputValue)
            );
            console.log(
              "Filtered categories for modal dropdown:",
              filteredCategories
            );

            if (
              inputValue &&
              !allCategories.some((cat) => cat.toLowerCase() === inputValue)
            ) {
              const newItem = document.createElement("div");
              newItem.className = "autocomplete-item";
              newItem.textContent = `Add "${this.value.trim()}"`;
              newItem.onclick = () => selectModalCategory(this.value.trim());
              dropdown.appendChild(newItem);
              console.log(
                `Added new category option: Add "${this.value.trim()}"`
              );
            }

            filteredCategories.forEach((category) => {
              const item = document.createElement("div");
              item.className = "autocomplete-item";
              item.textContent = category;
              item.onclick = () => selectModalCategory(category);
              dropdown.appendChild(item);
            });

            dropdown.style.display =
              filteredCategories.length || inputValue ? "block" : "none";
          });

        document
          .getElementById("modal-plugin-category")
          .addEventListener("focus", function () {
            console.log("Modal category input focused");
            updateModalCategoryDropdown();
            document.getElementById("modal-category-dropdown").style.display =
              "block";
          });

        document.addEventListener("click", function (e) {
          if (!e.target.closest("#modal-plugin-category")) {
            document.getElementById("modal-category-dropdown").style.display =
              "none";
          }
        });

        // Feather Icons 초기화
        function initFeatherIcons() {
          feather.replace();
          console.log("Feather icons initialized");

          const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
              if (mutation.type === "childList") {
                feather.replace();
                console.log("Feather icons updated due to DOM mutation");
              }
            });
          });

          observer.observe(document.body, {
            childList: true,
            subtree: true,
          });
        }

        document.addEventListener("DOMContentLoaded", initFeatherIcons);

        // code.ts로부터의 메시지 처리
        window.onmessage = (event) => {
          const message = event.data.pluginMessage;
          if (message) {
            console.log("Received message from plugin:", message);
            if (message.type === "plugins-list") {
              renderPluginList(message.plugins);
            } else if (message.type === "search-results") {
              renderSearchResults(message.results);
            } else if (message.type === "plugin-added") {
              showToast("Plugin added successfully");
              console.log("Plugin added, requesting updated plugin list");
              parent.postMessage(
                { pluginMessage: { type: "get-plugins" } },
                "*"
              ); // My Plugin List 업데이트 요청
              switchTab("plugin-list");
            } else if (message.type === "show-category-modal") {
              showAddPluginModalWithPlugin(message.plugin);
            } else if (message.type === "default-plugins") {
              defaultPlugins = message.plugins;
              currentDisplayedPlugins = defaultPlugins;
              console.log("Default plugins received:", defaultPlugins);
              renderDefaultPluginList(defaultPlugins);
              updateCategoryChips(defaultPlugins, "home");
            } else if (message.type === "search-ready") {
              searchReady = message.ready;
              searchInput.disabled = !searchReady;
              document.getElementById("search-loading").style.display =
                searchReady ? "none" : "flex";
            } else if (message.type === "fetch-start") {
              document.getElementById("search-loading").style.display = "flex";
            } else if (message.type === "fetch-complete") {
              document.getElementById("search-loading").style.display = "none";
            }
          }
        };

        // 검색 결과에서 플러그인 추가 모달 표시
        function showAddPluginModalWithPlugin(plugin) {
          selectedPlugin = plugin; // 선택된 플러그인을 저장
          const modal = document.getElementById("add-plugin-modal");
          document.getElementById("modal-plugin-name").value =
            plugin.pluginName;
          document.getElementById("modal-plugin-url").value = plugin.pluginUrl;
          document.getElementById("modal-plugin-description").value =
            plugin.pluginDescription || "";
          document.getElementById("modal-plugin-category").value = "";
          modal.style.display = "block";
          console.log("Add Plugin Modal displayed with plugin:", plugin);

          // 모달의 'Add Plugin' 버튼 클릭 시 핸들러 수정
          modalAddPluginButton.onclick = function () {
            const category = document
              .getElementById("modal-plugin-category")
              .value.trim();
            console.log("Confirming add plugin with category:", category);

            if (!category) {
              showToast("Category is required");
              console.warn("Category is missing in add plugin confirmation");
              return;
            }

            const confirmAddMessage = {
              type: "confirm-add-plugin",
              plugin: selectedPlugin,
              category: category,
            };
            console.log(
              "Sending confirm-add-plugin message:",
              confirmAddMessage
            );
            parent.postMessage(
              {
                pluginMessage: confirmAddMessage,
              },
              "*"
            );
            document.getElementById("add-plugin-modal").style.display = "none";
            console.log("Add Plugin Modal closed after confirmation");
          };
        }

        // 초기화 시 기본 플러그인 목록 요청
        function loadDefaultPlugins() {
          console.log("Requesting default plugins list");
          parent.postMessage(
            { pluginMessage: { type: "get-default-plugins" } },
            "*"
          );
        }

        // 초기화 시 플러그인 로드
        function initialize() {
          loadDefaultPlugins();
          parent.postMessage({ pluginMessage: { type: "get-plugins" } }, "*");
          switchTab("home");
          console.log("Initialization complete");

          // 검색 입력 비활성화
          searchInput.disabled = !searchReady;
        }

        initialize();
      })();
    </script>
  </body>
</html>
